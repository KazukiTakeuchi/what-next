# 「これから私たちは、」Web版 — 実装仕様書（カップル専用）

## 1. プロジェクト概要

### 原作
「これから私たちは、」は、株式会社サグイネル（Xaquinel）が発売した協力型カードゲーム。「次なにする？」を楽しく決める思い出作り協力ゲーム。

### Web版の目的
原作の体験を**カップル専用（2人プレイ）**に特化してオンライン化。ブラウザだけで「次のデートで何する？」を楽しく決められるようにする。

### コアコンセプト
> 「相手がやりたいことの中から、自分もやりたいものを選ぶ」を繰り返し、最後に**二人のやりたいこと1つ**に収束させる。

---

## 2. ゲームルール

### 基本情報
- **プレイ人数**: 2人固定
- **所要時間**: 3〜5分
- **勝敗**: なし（二人で協力）
- **最終結果**: やりたいこと**1つ**に決まる

### ゲーム進行

#### Phase 0: 接続
1. プレイヤーAが「ルームをつくる」→ ルームURL発行
2. AがURLをパートナー（B）に共有
3. Bが開いて参加 → 二人揃ったら「はじめる」

#### Phase 1: カード配布
- 120枚からランダムに24枚を抽出
- A・Bに **12枚ずつ** 配布

#### Phase 2: ラウンド1「やりたいことを選ぶ」
- 各自が手札12枚から **「やりたい」5枚を選ぶ**（同時進行）
- 二人とも選び終わったら、選んだ5枚を**相手に渡す**

#### Phase 3: ラウンド2「相手の気持ちから選ぶ」
- 相手が選んだ5枚が届く
- その中から **「一番やりたい」1枚を選ぶ**（同時進行）
- 二人とも選び終わったら次へ

#### Phase 4: 最終決定
- 二人が選んだ1枚ずつ（計2枚）を公開
- **同じカード** → そのカードに即決定
- **違うカード** → 2枚を提示し、二人がどちらかに投票
  - 一致 → そのカードに決定
  - 割れた → ランダムでどちらかに決定

#### Phase 5: 結果発表
- 決定した **1枚のカード** を演出付きで表示
- 「これから私たちは、〇〇」の形で表示

---

## 3. 画面構成

### 3.1 トップ画面 (`/`)
- ゲームタイトル
- 「ルームをつくる」ボタン
- 「ルームに参加する」+ コード入力欄
- ニックネーム入力欄

### 3.2 待機画面 (`/room/:code`)
- ルームURL表示（タップでコピー）
- 「パートナーにURLを送ろう！」の案内
- 参加状況（「待っています...」→「○○が来ました！」）
- 「はじめる」ボタン（二人揃ったら表示）

### 3.3 ゲーム画面 (`/room/:code/game`)

#### ラウンド1
- ヘッダー:「やりたいこと5つ選んでね」
- カード12枚をグリッド表示（スマホ2列×6行）
- タップで選択/解除（選択済みはハイライト）
- カウンター:「あと○枚」
- 「決定」ボタン（5枚選んだら有効化）
- 相手の状態:「選んでいます...」/「選びました！」

#### ラウンド間演出
- カードが相手に届くアニメーション

#### ラウンド2
- ヘッダー:「○○が選んだカード。一番やりたいのは？」
- カード5枚を大きめに表示
- タップで1枚を選択
- 「これにする！」ボタン

#### 最終投票（カードが割れた場合のみ）
- 2枚のカードを並べて表示
- 「どっちがいい？」
- 各自タップで投票

### 3.4 結果画面 (`/room/:code/result`)
- カード裏面 → めくり演出で1枚オープン
- 「これから私たちは、」+ カードテキスト を大きく表示
- 「もういっかい」ボタン

---

## 4. 状態遷移

```
[トップ] → ルーム作成/参加 → [待機画面]
  → 二人揃う → はじめる
  → [ラウンド1] 12枚→5枚選択 → 二人とも完了 → カード交換
  → [ラウンド2] 5枚→1枚選択 → 二人とも完了 → カード公開
  → (同じカード) → [結果画面]
  → (違うカード) → [最終投票] → 決定 → [結果画面]
  → もういっかい → [待機画面]
```

---

## 5. データモデル

```typescript
type Room = {
  code: string;              // 4桁ルームコード
  players: {
    a: Player | null;
    b: Player | null;
  };
  status: "waiting" | "playing" | "finished";
  game_state: GameState | null;
  created_at: string;        // ISO timestamp
};

type Player = {
  id: string;                // UUID
  nickname: string;
  is_host: boolean;
};

type Card = {
  id: number;                // 1〜120
  text: string;
  category: CardCategory;
};

type CardCategory =
  | "outing"
  | "gourmet"
  | "drive"
  | "culture"
  | "chill"
  | "romantic"
  | "challenge";

type GameState = {
  round: 1 | 2 | "vote" | "result";
  hands: { a: number[]; b: number[] };
  selections: { a: number[] | null; b: number[] | null };
  final_picks: { a: number | null; b: number | null };
  votes: { a: number | null; b: number | null };
  decided_card: number | null;
};

const ROUND_CONFIG = [
  { round: 1, hand_size: 12, keep_count: 5 },
  { round: 2, hand_size: 5,  keep_count: 1 },
] as const;
```

---

## 6. リアルタイム通信

Supabase Realtime の **Broadcast** と **Presence** を使用。

### Broadcast イベント（チャンネル: `room:{code}`）

| イベント | 送信者 | データ | 説明 |
|---------|--------|--------|------|
| `player_joined` | クライアント | `{ player }` | パートナー参加 |
| `game_start` | ホスト | `{ hands }` | ゲーム開始+手札配布 |
| `selection_done` | クライアント | `{ player_id }` | カード選択完了通知 |
| `cards_exchange` | クライアント | `{ cards: number[] }` | 選んだカードを相手に送信 |
| `final_pick` | クライアント | `{ card_id }` | 最終1枚の選択 |
| `vote` | クライアント | `{ card_id }` | 最終投票 |
| `decided` | クライアント | `{ card_id }` | 最終決定 |
| `play_again` | クライアント | — | もう一回 |

### Presence（接続状態管理）
- 各プレイヤーのオンライン/オフラインを追跡
- 切断時に相手に通知

---

## 7. 技術スタック（すべて無料）

| レイヤー | 技術 | 無料枠 |
|---------|------|--------|
| フロントエンド | React + TypeScript (Vite) | — |
| スタイリング | Tailwind CSS | — |
| リアルタイム通信 | Supabase Realtime (Broadcast + Presence) | 50万メッセージ/月, 同時接続200 |
| データベース | Supabase PostgreSQL | 500MB, 5万行 |
| ホスティング | Cloudflare Pages | 無制限リクエスト, 帯域無制限 |
| ドメイン | Cloudflare Pages デフォルト (*.pages.dev) | 無料 |
| アニメーション | CSS Animations + Framer Motion | — |

### 構成図
```
[ブラウザA] ←→ [Supabase Realtime] ←→ [ブラウザB]
                     ↕
              [Supabase DB (ルーム管理)]

静的ファイル配信: Cloudflare Pages
```

### なぜこの構成か
- **サーバーレス**: 自前サーバー不要、運用コスト0円
- **Supabase無料枠**: カップル向けの小規模利用には十分すぎる
- **Cloudflare Pages**: 帯域無制限で完全無料
- **Vite + React**: 軽量SPA、ビルドが速い、SSR不要

### デプロイ手順
1. Supabaseプロジェクト作成（無料）→ URLとanon keyを取得
2. Supabaseにテーブル作成（rooms テーブル）
3. GitHubリポジトリにコードをpush
4. Cloudflare Pagesでリポジトリを接続 → 自動デプロイ
5. 環境変数にSupabaseのURL/keyを設定

---

## 8. Supabase テーブル設計

```sql
-- ルーム管理テーブル
create table rooms (
  code text primary key,           -- 4桁ルームコード
  host_id text not null,           -- ホストのUUID
  host_nickname text not null,
  guest_id text,                   -- ゲストのUUID
  guest_nickname text,
  status text not null default 'waiting',  -- waiting / playing / finished
  game_state jsonb,                -- ゲーム状態（JSON）
  created_at timestamptz default now()
);

-- 古いルームを自動削除（1時間）
-- Supabase の pg_cron か、クライアント側で作成時にTTLチェック
```

> ゲームロジック（シャッフル、配布、選別）は**クライアントサイド**で処理。Supabase DBはルームの存在確認と参加管理のみ。リアルタイムのカード交換はBroadcastで直接通信。

---

## 9. カードデータ（カップル向け120枚）

カードデータはフロントエンドに静的JSONとして埋め込む。

### おでかけ（18枚）
1. 海を見に行く
2. 夜の海に行く
3. 公園でピクニックする
4. 知らない街を散歩する
5. 展望台に行く
6. 水族館に行く
7. 動物園に行く
8. 植物園に行く
9. 神社にお参りに行く
10. 日帰り温泉に行く
11. フリーマーケットに行く
12. 朝市に行く
13. ビーチを裸足で歩く
14. 山の上で朝日を見る
15. 川沿いをゆっくり歩く
16. 噴水のある広場でのんびりする
17. 屋上に行ってみる
18. 猫カフェに行く

### ドライブ・旅行（15枚）
19. 海沿いをドライブする
20. 夜の高速をドライブする
21. 行き先を決めずに電車に乗る
22. 日帰り旅行に行く
23. 隣の県まで行ってみる
24. 空港に飛行機を見に行く
25. フェリーに乗る
26. 始発電車に乗ってどこか行く
27. サービスエリアを巡る
28. 知らない駅で降りてみる
29. 温泉旅行に行く
30. 夜行バスで遠くへ行く
31. レンタサイクルで街を巡る
32. ローカル線に乗る
33. 地図を見ないで散策する

### グルメ（18枚）
34. おしゃれなカフェを探す
35. 食べたことない料理を食べに行く
36. 手料理を作り合う
37. 手巻き寿司パーティー
38. ホットケーキを焼く
39. 朝ごはんを食べに行く
40. コンビニスイーツを全種類買う
41. 食べ歩きデートする
42. 二人でお弁当を作って出かける
43. いつもは頼まないメニューを頼む
44. ケーキを一緒に焼く
45. 市場で食材を買って料理する
46. たこ焼きパーティーをする
47. クレープを食べに行く
48. パフェを食べに行く
49. ラーメン屋を開拓する
50. 飲み比べをする
51. チョコフォンデュをする

### カルチャー・エンタメ（17枚）
52. 前情報なしで映画を観る
53. 本屋で互いに1冊プレゼントし合う
54. 美術館に行く
55. カラオケで歌い合う
56. プラネタリウムに行く
57. 脱出ゲームに挑戦する
58. ボウリングで対決する
59. ゲームセンターで遊ぶ
60. 古着屋を巡る
61. 写真を撮りまくる
62. 二人で短い動画を撮る
63. 漫画喫茶に行く
64. ライブに行く
65. レコード屋・CDショップに行く
66. 同じ本を読んで感想を言い合う
67. 二人でスケッチ大会をする
68. 一緒にジグソーパズルをやる

### まったり（18枚）
69. 映画マラソンをする
70. 夜通し語り合う
71. 一緒にお昼寝する
72. お互いの好きな曲を紹介し合う
73. アルバムを見返す
74. 一緒に模様替えする
75. 二人で筋トレする
76. マッサージし合う
77. 一緒にゲームで遊ぶ
78. お互いの子供の頃の話をする
79. 二人の将来について話す
80. 星座占いを見て盛り上がる
81. お互いの好きなところを言い合う
82. 一緒にヨガをする
83. 二人で料理動画を見ながら作る
84. 同じアニメを一気見する
85. お揃いのパジャマで過ごす
86. 一緒にお風呂に入る

### ロマンチック（17枚）
87. 夜景を見に行く
88. 星空を見に行く
89. イルミネーションを見に行く
90. 夕日を見に行く
91. 手をつないで夜散歩する
92. 手紙を書き合う
93. 未来の二人に手紙を書く
94. お揃いのものを買いに行く
95. 二人の記念写真を撮る
96. ペアリングを見に行く
97. 花を買って帰る
98. サプライズを計画する
99. 思い出の場所に行く
100. 二人だけの秘密の場所を作る
101. キャンドルを灯して過ごす
102. フォトブックを作る
103. 二人の記念日リストを作る

### チャレンジ・新体験（17枚）
104. 二人で早起きして朝活する
105. 一日スマホなしで過ごす
106. お互いの服をコーディネートし合う
107. 似顔絵を描き合う
108. 二人でヒッチハイクしてみる
109. 外国語だけで会話してみる
110. 行ったことない場所に行く
111. 相手のおすすめスポットに行く
112. 二人で料理教室に行く
113. 陶芸体験をする
114. サーフィンに挑戦する
115. ボルダリングに挑戦する
116. 二人でランニングする
117. 大声で「好き」と叫ぶ
118. タイムカプセルを埋める
119. 二人だけのルールを決める
120. 今日という日を全力で楽しむ

---

## 10. 非機能要件

- **スマホファースト**: タップ操作最優先
- **ルーム有効期限**: 1時間で自動削除
- **切断復帰**: リロードで自動再接続（sessionStorageにプレイヤーID保持）
- **カードテキスト**: 最小16px
- **費用**: 完全無料（Supabase無料枠 + Cloudflare Pages無料）

---

## 11. MVP（最小実装範囲）

### 含める
1. ルーム作成・参加（URLシェア）
2. ニックネーム入力
3. カード配布（12枚ずつ）
4. ラウンド1: 12枚→5枚選択 → 交換
5. ラウンド2: 5枚→1枚選択
6. 最終投票（カードが割れた場合）
7. 結果発表（1枚に決定、演出付き）
8. もういっかい遊ぶ

### MVP外（将来）
- 思い出記録・履歴
- SNSシェア
- カスタムカード追加
- 季節限定カードパック
